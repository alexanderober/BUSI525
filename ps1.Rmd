---
title: "Problem Sheet 1"
author: "Alexander Ober"
date: "1/16/2022"
output:
  pdf_document: default
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Problem 1

Note throughout I construct p-values, etc., as if the alternative is one-sided, since presumably we don't care if the alpha is negative.
### (a)

```{r, echo = FALSE}
## generate variables and simulated data
N <- 1000
T <- 120
mean_mkt <- 0.05/12
sd_mkt <- 0.2/sqrt(12)
sd_res <- 0.3/sqrt(12)
alpha <- rep(0, N)

M <- matrix(rep(rnorm(T, mean = mean_mkt, sd = sd_mkt), N), nrow=T)
M_res <- matrix(rnorm(N*T, mean = 0, sd = sd_res), nrow=T)
M_alpha <- matrix(rep(alpha, T), nrow = T)

## simulate returns in a T by N matrix. Each column is a fund.
M_ret <- M_alpha + M + M_res

## initialize alpha estimates, pvalues, and tstats
alpha_hat = rep(0, N)
pvals = rep(0, N)
tstats = rep(0, N)

## run a regression for each fund 
for (i in 1:N){
  Y <- M_ret[, i]
  X <- M[, i]
  
  mod <- lm(Y~X)
  summ <- summary(mod)
  
  alpha_hat[i] <- summ$coefficients[1, 1]
  tstats[i] <- summ$coefficients[1, 3]
  ## generate one-sided p-value (default output is two-sided)
  pvals[i] <- ifelse(tstats[i] > 0, 
                     summary(mod)$coefficients[1, 4]/2,
                     1 - summary(mod)$coefficients[1, 4]/2)
                     
}

```
`r length(pvals[pvals < 0.05])` of the 1000 funds have significantly positive alphas. We'd expect about 5% of the statistics to be significant, which is what we see.

### (b)
Here are some plots:

```{r, echo = FALSE}
hist(pvals, breaks = 10)
hist(tstats, breaks = 16)
```

### (c)
The distribution looks essentially uniform[0, 1]. This is not too surprising, as under the null the coefficients have a t distribution centered at 0, so p values are uniformly distributed. (For any $p \in \mathbb{R},$ if $F$ is the t stat cdf under the null, and the alternative is of the form $tstat > 0$, then by symmetry of the t-distribution cdf, $$ Prob(pval < p) = P(F^{-1}(pval) < F^{-1}(p)) = P(1 - tstat < F^{-1}(p)) = 1 - F(1 - F^{-1}(p)) = 1 - (1 -p) = p.$$)

## Problem 2

### (a)

```{r, echo = FALSE}
j <- 0
## intialize the true positive, false negative, false positive and true negative 
## vectors for part (b)
tp <- rep(0, 5)
fn <- rep(0, 5)
fp <- rep(0, 5)
tn <- rep(0, 5)
for (lambda in c(0.1, 0.25, 0.5, 0.75)){
  
  ## generate a proportion of positive alphas
  alpha <- c(rep(0.025/12, lambda*N), rep(0, (1-lambda)*N))
  M_alpha <- matrix(rep(alpha, T), nrow = T, byrow = TRUE)
  
  ## skilled funds correspond to the first lambda*N columns of the matrix
  M_ret <- M_alpha + M + M_res
  
  alpha_hat = rep(0, N)
  pvals = rep(0, N)
  tstats = rep(0, N)
  
  ## run regressions for each fund
  for (i in 1:N){
    Y <- M_ret[, i]
    X <- M[, i]
    
    mod <- lm(Y~X)
    summ <- summary(mod)
    
    alpha_hat[i] <- summ$coefficients[1, 1]
    tstats[i] <- summ$coefficients[1, 3]
    ## generate one-sided p-value (default output is two-sided)
    pvals[i] <- ifelse(tstats[i] > 0, 
                     summary(mod)$coefficients[1, 4]/2,
                     1 - summary(mod)$coefficients[1, 4]/2)
  }
  
  ## generate some histograms
  title = paste0("Histogram of Alphas: lambda = ", lambda)
  hist(alpha_hat, breaks = 10, main = title)
  title = paste0("Histogram of p-values: lambda = ", lambda)
  hist(pvals, breaks = 20, main = title)
  title = paste0("Histogram of t-stats: lambda = ", lambda)
  hist(tstats, breaks = 16, main = title)
  
  ## compute false positives and negatives
  skilled_pvals <- pvals[1:(lambda*N)]
  skilled_tstats <- tstats[1:(lambda*N)]
  
  unskilled_pvals <- pvals[(lambda*N+1):N]
  unskilled_tstats <- tstats[(lambda*N+1):N]
  
  j <- j+1
  
  tp[j] <- length(skilled_pvals[skilled_pvals < 0.05])
  fn[j] <- lambda*N - tp[j]
  fp[j] <- length(unskilled_pvals[unskilled_pvals < 0.05])
  tn[j] <- (1-lambda)*N - fp[j]
}
```

The distributions of t-stats and p-values visibly shift to the right as we increase lambda, which is what we'd expect as more of the funds are skilled. However, although the p-values do shift a little bit to the left (i.e., towards more slopes being statistically non-zero), the shift isn't massive. This is perhaps not too surprising since there's a lot of noise in the error terms, making skill fairly challenging to detect even when the alpha is half the market risk premium.  

### (b)

Below I construct four tables. The percentage (multiply by 1000 for the number) of truly skilled funds with insignificant alpha estimates is given in the false negative cell. This number is generally around 90\% or maybe a bit more of the total number of skilled funds. The number of truly unskilled funds identified as skilled based on significantly positive alpha estimates is given in the false positive cell, and generally consists of around 5\% of the unskilled funds. This is what we'd expect under the null of no skill.

Lambda = 0.1
\begin{center}
\begin{tabular}{ c|cc|c } 
 
 Truth\textbackslash Estimate & Positive & Negative &Total \\ 
 \hline
 True & `r tp[1]/N` & `r fn[1]/N` & `r tp[1]/N + fn[1]/N`\\ 
 False & `r fp[1]/N` & `r tn[1]/N` & `r fp[1]/N + tn[1]/N`\\ 
 \hline 
 Total & `r tp[1]/N + fp[1]/N` & `r fn[1]/N + tn[1]/N`&
\end{tabular}
\end{center}

Lambda = 0.25
\begin{center}
\begin{tabular}{ c|cc|c } 
 
 Truth\textbackslash Estimate & Positive & Negative &Total \\ 
 \hline
 True & `r tp[2]/N` & `r fn[2]/N` & `r tp[2]/N + fn[2]/N`\\ 
 False & `r fp[2]/N` & `r tn[2]/N` & `r fp[2]/N + tn[2]/N`\\ 
 \hline 
 Total & `r tp[2]/N + fp[2]/N` & `r fn[2]/N + tn[2]/N`&
\end{tabular}
\end{center}

Lambda = 0.5
\begin{center}
\begin{tabular}{ c|cc|c } 
 
 Truth\textbackslash Estimate & Positive & Negative&Total \\ 
 \hline
 True & `r tp[3]/N` & `r fn[3]/N` & `r tp[3]/N + fn[3]/N`\\ 
 False & `r fp[3]/N` & `r tn[3]/N` & `r fp[3]/N + tn[3]/N`\\ 
 \hline 
 Total & `r tp[3]/N + fp[3]/N` & `r fn[3]/N + tn[3]/N`&
\end{tabular}
\end{center}

Lambda = 0.75
\begin{center}
\begin{tabular}{ c|cc|c } 
 
 Truth\textbackslash Estimate & Positive & Negative&Total \\ 
 \hline
 True & `r tp[4]/N` & `r fn[4]/N` & `r tp[4]/N + fn[4]/N`\\ 
 False & `r fp[4]/N` & `r tn[4]/N` & `r fp[4]/N + tn[4]/N`\\ 
 \hline 
 Total & `r tp[4]/N + fp[4]/N` & `r fn[4]/N + tn[4]/N`&
\end{tabular}
\end{center}
